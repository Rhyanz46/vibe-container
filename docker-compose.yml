# Docker Compose configuration for Claude Code (2026 edition)
# Optimized for Ubuntu 24.04 LTS and modern Docker features

services:
  claude-code:
    build:
      context: .
      dockerfile: Dockerfile
      # Build arguments for customization
      args:
        - UBUNTU_VERSION=24.04
        - NODE_VERSION=20
    container_name: claude-code-container
    image: claude-code:2026.1
    # Use restart policy for better resilience
    restart: unless-stopped
    # Auto-start SSH server after container starts
    entrypoint:
      - /bin/bash
      - -c
      - |
        # Run original entrypoint in background
        /usr/local/bin/claude-entrypoint.sh &
        # Wait a moment for entrypoint to initialize
        sleep 3
        # Create dev user if not exists
        if ! grep "^dev:" /etc/passwd > /dev/null; then
          # Create without -m flag because home dir already exists from mount
          sudo useradd -u 1002 -s /bin/bash -d /home/dev dev
          # Set permanent password
          echo "dev:dev123" | sudo chpasswd
          # Add to sudo group for permanent sudo access
          sudo usermod -aG sudo dev
          echo "✅ User dev created (UID 1002) with password and sudo access"
        else
          # Fix dev user shell
          sudo usermod -s /bin/bash dev 2>/dev/null || true
          # Ensure password is set (only if password is locked/empty)
          if sudo passwd -S dev | grep -q " L "; then
            echo "dev:dev123" | sudo chpasswd
            echo "✅ Dev user password set"
          fi
          # Ensure dev user is in sudo group
          if ! groups dev | grep -q "\bsudo\b"; then
            sudo usermod -aG sudo dev
            echo "✅ Dev user added to sudo group"
          fi
        fi
        # Start SSH server
        /usr/local/bin/start-sshd.sh
        # Keep container running
        tail -f /dev/null

    # ===== SECURITY: Run as non-root user =====
    # Container runs as 'claude' user (UID 1001) instead of root
    # This improves security by following the principle of least privilege
    user: "1001:1001"

    # Mount volumes for persistent data
    volumes:
      # ===== GPU/DISPLAY ACCESS (For hardware acceleration) =====
      # X11 socket for GUI applications and hardware rendering
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # DRI devices for GPU hardware acceleration (only if available on host)
      # - /dev/dri:/dev/dri:rw
      # X11 authority file (optional - uncomment if you get X11 authentication errors)
      # - ${HOME}/.Xauthority:/home/claude/.Xauthority:ro

      # ===== USER HOME DIRECTORIES =====
      # Full home directory mounts for complete persistence
      - ./data/home/claude:/home/claude
      - ./data/home/dev:/home/dev

      # ===== SSH SERVER CONFIG =====
      # SSH server configuration (persistent)
      - ./config/ssh/etc-ssh/sshd_config:/etc/ssh/sshd_config
      # SSH server auto-start script
      - ./scripts/ssh/start-sshd.sh:/usr/local/bin/start-sshd.sh

      # Optional: Mount git config from host
      # Uncomment to use your host's git configuration
      # - ~/.gitconfig:/home/claude/.gitconfig:ro

    # Keep container running for interactive use
    stdin_open: true
    tty: true

    # ===== TMPFS FOR PERFORMANCE =====
    # Mount temporary file systems in memory for faster operations
    # This reduces disk I/O and improves performance for cache-heavy operations
    tmpfs:
      - /tmp:rw,size=512m
      - /run/sshd:rw,size=10m,mode=0755

    # Working directory inside container
    working_dir: /home/claude/workspace

    # ===== DEVICE ACCESS FOR HARDWARE ACCELERATION =====
    # Uncomment below if you have DRI devices on your host
    # devices:
    #   # DRI (Direct Rendering Infrastructure) for GPU access (if available)
    #   - /dev/dri/card0:/dev/dri/card0
    #   - /dev/dri/renderD128:/dev/dri/renderD128
    #   # Video acceleration devices (optional, for hardware video decoding)
    #   - /dev/video0:/dev/video0

    # ===== GPU RUNTIME (NVIDIA/AMD) =====
    # Uncomment if using NVIDIA GPU and nvidia-docker installed
    # runtime: nvidia

    # Environment variables
    environment:
      # ===== DISPLAY SERVER =====
      - DISPLAY=${DISPLAY:-:0}
      # X11 authority file for display authentication
      - XAUTHORITY=${XAUTHORITY:-/home/claude/.Xauthority}

      # ===== HARDWARE ACCELERATION =====
      # Enable hardware acceleration for browsers and GUI apps
      # Only works if GPU is available, otherwise falls back to software rendering
      - LIBGL_ALWAYS_SOFTWARE=${LIBGL_ALWAYS_SOFTWARE:-0}
      # For NVIDIA GPUs (uncomment if you have NVIDIA)
      # - __NV_PRIME_RENDER_OFFLOAD=1
      # - __GLX_VENDOR_LIBRARY_NAME=nvidia

      # Disable auto-updates inside container (recommended)
      - DISABLE_AUTOUPDATER=1
      # Node.js environment
      - NODE_ENV=development
      # Timezone
      - TZ=UTC

      # ===== TERMINAL COLOR SUPPORT =====
      # Set proper TERM for color support in CLI applications
      - TERM=${TERM:-xterm-256color}

      # ===== CONTAINER CONTEXT =====
      # Indicate that we're in an isolated container
      # This helps Claude AI understand the environment
      - CONTAINER_ENV=isolated
      - NETWORK_MODE=host

      # ===== DOCKER DAEMON ACCESS =====
      # Connect to host Docker daemon via TCP (Colima/Linux)
      # No socket mount needed - cleaner and more secure!
      - DOCKER_HOST=tcp://localhost:2375

    # ===== HOST NETWORK MODE =====
    # Use host network for automatic port exposure
    # All ports in container will be directly accessible on host
    # Perfect for development - no port mapping needed!
    network_mode: host

    # Note: No resource limits set - container can use all available host resources
    # Remove this section if you want to add limits back
    # deploy:
    #   resources:
    #     limits:
    #       memory: 6G
    #       cpus: '3'

    # Health check (optional but recommended)
    healthcheck:
      test: ["CMD", "claude", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Note: networks section removed because we're using host network mode
# With host network, container shares the host's network stack directly

# Note: No named volumes needed - all Claude Code data stored in ./data/ directory
# Workspace is mounted from host at ./data/workspace for persistent development
# Data structure:
# ./data/workspace/              - Development workspace (persistent projects)
# ./data/.claude/                - Claude Code config (API keys, settings)
# ./data/.local/                 - Claude Code local files
# ./data/.local/share/claude/   - Conversations, cache
# ./data/.mcp/                   - MCP server configs
# ./data/.npm/                   - npm package cache
# ./data/.nvm/                   - NVM (Node Version Manager) and globally installed npm packages
# ./data/.ssh/                   - SSH keys (git operations)
# ./data/go/                     - Go workspace and packages
# ./data/.cache/go-build/        - Go build cache
# ./data/.cache/ms-playwright/   - Playwright browsers (persistent installation)
# ./data/flutter/                - Flutter SDK (persistent installation)
# ./data/.cargo/                 - Cargo packages and crates (persistent installation)
# ./data/.rustup/                - Rustup toolchains (persistent installation)
# ./data/.kotlin/                - Kotlin compiler and SDK (persistent installation)
# ./data/.java/                  - Java OpenJDK (persistent installation)
# ./data/.docker/                - Docker CLI (persistent installation)
#
# Note: Java and Docker CLI now use persistent volumes instead of system directories
# This keeps the Docker image small while maintaining persistence across rebuilds
